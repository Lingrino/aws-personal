{
    "builders": [
        {
            "name": "docker-bastion",
            "type": "docker",
            "image": "ubuntu:focal",
            "discard": true
        },
        {
            "name": "docker-vault",
            "type": "docker",
            "image": "ubuntu:focal",
            "discard": true
        },
        {
            "name": "ec2-bastion",
            "type": "amazon-ebs",
            "source_ami_filter": {
                "filters": {
                    "name": "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*",
                    "root-device-type": "ebs",
                    "virtualization-type": "hvm"
                },
                "owners": [
                    "099720109477"
                ],
                "most_recent": true
            },
            "region": "us-east-1",
            "subnet_filter": {
                "filters": {
                    "tag:default": "true",
                    "tag:type": "public"
                },
                "random": true
            },
            "spot_price": "auto",
            "spot_instance_types": [
                "t3.nano",
                "t3.micro",
                "t3.small",
                "t3.medium"
            ],
            "spot_tags": {
                "Name": "bastion",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "ssh_username": "ubuntu",
            "ssh_interface": "public_ip",
            "shutdown_behavior": "terminate",
            "run_tags": {
                "Name": "bastion",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "run_volume_tags": {
                "Name": "bastion",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "ami_name": "bastion-{{ timestamp }}",
            "ami_description": "a general AMI for my bastion infrastructure",
            "ami_regions": [
                "us-east-1"
            ],
            "tags": {
                "Name": "bastion",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            }
        },
        {
            "name": "ec2-vault",
            "type": "amazon-ebs",
            "source_ami_filter": {
                "filters": {
                    "name": "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*",
                    "root-device-type": "ebs",
                    "virtualization-type": "hvm"
                },
                "owners": [
                    "099720109477"
                ],
                "most_recent": true
            },
            "region": "us-east-1",
            "subnet_filter": {
                "filters": {
                    "tag:default": "true",
                    "tag:type": "public"
                },
                "random": true
            },
            "spot_price": "auto",
            "spot_instance_types": [
                "t3.nano",
                "t3.micro",
                "t3.small",
                "t3.medium"
            ],
            "spot_tags": {
                "Name": "vault",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "ssh_username": "ubuntu",
            "ssh_interface": "public_ip",
            "shutdown_behavior": "terminate",
            "run_tags": {
                "Name": "vault",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "run_volume_tags": {
                "Name": "vault",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "ami_name": "vault-{{ timestamp }}",
            "ami_description": "a general AMI for my vault infrastructure",
            "ami_regions": [
                "us-east-1"
            ],
            "tags": {
                "Name": "vault",
                "build_date": "{{ timestamp }}",
                "os": "ubuntu",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            }
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "apt-get update",
                "apt-get install -y sudo systemd python3 software-properties-common"
            ],
            "only": [
                "docker-bastion",
                "docker-vault"
            ]
        },
        {
            "type": "ansible",
            "playbook_file": "../ansible/bastion.yml",
            "user": "ubuntu",
            "inventory_directory": "../ansible",
            "host_alias": "bastion",
            "groups": [
                "bastions"
            ],
            "only": [
                "docker-bastion",
                "ec2-bastion"
            ]
        },
        {
            "type": "ansible",
            "playbook_file": "../ansible/vault.yml",
            "user": "ubuntu",
            "inventory_directory": "../ansible",
            "host_alias": "vault",
            "groups": [
                "vaults"
            ],
            "only": [
                "docker-vault",
                "ec2-vault"
            ]
        }
    ]
}
