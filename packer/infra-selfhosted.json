{
    "builders": [
        {
            "name": "docker-amazonlinux2",
            "type": "docker",
            "image": "amazonlinux:2",
            "discard": true
        },
        {
            "name": "ec2-amazonlinux2",
            "type": "amazon-ebs",
            "source_ami_filter": {
                "filters": {
                    "name": "amzn2-ami-hvm-*-x86_64-gp2",
                    "root-device-type": "ebs",
                    "virtualization-type": "hvm"
                },
                "owners": [
                    "amazon"
                ],
                "most_recent": true
            },
            "region": "us-east-1",
            "subnet_filter": {
                "filters": {
                    "tag:default": "true",
                    "tag:type": "public"
                },
                "random": true
            },
            "spot_price": "auto",
            "spot_price_auto_product": "Linux/UNIX (Amazon VPC)",
            "spot_instance_types": [
                "t3.nano",
                "t3.micro",
                "t3.small",
                "t3.medium"
            ],
            "spot_tags": {
                "Name": "infra-selfhosted",
                "build_date": "{{ timestamp }}",
                "os": "amazonlinux2",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "ssh_username": "ec2-user",
            "ssh_interface": "public_ip",
            "shutdown_behavior": "terminate",
            "run_tags": {
                "Name": "infra-selfhosted",
                "build_date": "{{ timestamp }}",
                "os": "amazonlinux2",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "run_volume_tags": {
                "Name": "infra-selfhosted",
                "build_date": "{{ timestamp }}",
                "os": "amazonlinux2",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            },
            "ami_name": "infra-selfhosted-{{ timestamp }}",
            "ami_description": "a general AMI for my self hosted infrastructure",
            "ami_users": [
                "038361916180",
                "840856573771"
            ],
            "ami_regions": [
                "us-east-1"
            ],
            "tags": {
                "Name": "infra-selfhosted",
                "build_date": "{{ timestamp }}",
                "os": "amazonlinux2",
                "packer": "true",
                "packer_version": "{{ packer_version }}",
                "source_ami_id": "{{ .SourceAMI }}",
                "source_ami_name": "{{ .SourceAMIName }}"
            }
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "yum install -y sudo shadow-utils systemd python3"
            ],
            "only": [
                "docker-amazonlinux2"
            ]
        },
        {
            "type": "ansible",
            "playbook_file": "../ansible/site.yml"
        }
    ]
}
